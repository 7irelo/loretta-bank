name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging
      deploy_discovery:
        description: Deploy discovery-service
        type: boolean
        default: true
      deploy_gateway:
        description: Deploy api-gateway
        type: boolean
        default: true
      deploy_auth:
        description: Deploy auth-service
        type: boolean
        default: true
      deploy_customer:
        description: Deploy customer-service
        type: boolean
        default: true
      deploy_account:
        description: Deploy account-service
        type: boolean
        default: true
      deploy_transaction:
        description: Deploy transaction-service
        type: boolean
        default: true
      deploy_notification:
        description: Deploy notification-service
        type: boolean
        default: true
      deploy_audit:
        description: Deploy audit-service
        type: boolean
        default: true
      deploy_reporting:
        description: Deploy reporting-service
        type: boolean
        default: true
      deploy_frontend:
        description: Deploy frontend
        type: boolean
        default: true

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: af-south-1

jobs:
  # ── Determine what to build and where to deploy ──────────────
  prepare:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      eks_cluster: ${{ steps.config.outputs.eks_cluster }}
      services: ${{ steps.config.outputs.services }}
    steps:
      - name: Resolve deployment config
        id: config
        run: |
          # Default: push to main deploys all services to staging
          if [ "${{ github.event_name }}" = "push" ]; then
            ENV="staging"
            SERVICES='["discovery-service","api-gateway","auth-service","customer-service","account-service","transaction-service","notification-service","audit-service","reporting-service","frontend"]'
          else
            ENV="${{ inputs.environment }}"
            SERVICES="[]"
            [ "${{ inputs.deploy_discovery }}" = "true" ]     && SERVICES=$(echo "$SERVICES" | jq -c '. + ["discovery-service"]')
            [ "${{ inputs.deploy_gateway }}" = "true" ]       && SERVICES=$(echo "$SERVICES" | jq -c '. + ["api-gateway"]')
            [ "${{ inputs.deploy_auth }}" = "true" ]          && SERVICES=$(echo "$SERVICES" | jq -c '. + ["auth-service"]')
            [ "${{ inputs.deploy_customer }}" = "true" ]      && SERVICES=$(echo "$SERVICES" | jq -c '. + ["customer-service"]')
            [ "${{ inputs.deploy_account }}" = "true" ]       && SERVICES=$(echo "$SERVICES" | jq -c '. + ["account-service"]')
            [ "${{ inputs.deploy_transaction }}" = "true" ]   && SERVICES=$(echo "$SERVICES" | jq -c '. + ["transaction-service"]')
            [ "${{ inputs.deploy_notification }}" = "true" ]  && SERVICES=$(echo "$SERVICES" | jq -c '. + ["notification-service"]')
            [ "${{ inputs.deploy_audit }}" = "true" ]         && SERVICES=$(echo "$SERVICES" | jq -c '. + ["audit-service"]')
            [ "${{ inputs.deploy_reporting }}" = "true" ]     && SERVICES=$(echo "$SERVICES" | jq -c '. + ["reporting-service"]')
            [ "${{ inputs.deploy_frontend }}" = "true" ]      && SERVICES=$(echo "$SERVICES" | jq -c '. + ["frontend"]')
          fi

          if [ "$ENV" = "production" ]; then
            CLUSTER="loretta-bank-production"
          else
            CLUSTER="loretta-bank-staging"
          fi

          echo "environment=$ENV" >> "$GITHUB_OUTPUT"
          echo "eks_cluster=$CLUSTER" >> "$GITHUB_OUTPUT"
          echo "services=$SERVICES" >> "$GITHUB_OUTPUT"

  # ── Build and push selected service images to ECR ────────────
  build-push:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - { service: discovery-service,     context: server, dockerfile: discovery-service/Dockerfile }
          - { service: api-gateway,           context: server, dockerfile: api-gateway/Dockerfile }
          - { service: auth-service,          context: server, dockerfile: auth-service/Dockerfile }
          - { service: customer-service,      context: server, dockerfile: customer-service/Dockerfile }
          - { service: account-service,       context: server, dockerfile: account-service/Dockerfile }
          - { service: transaction-service,   context: server, dockerfile: transaction-service/Dockerfile }
          - { service: notification-service,  context: server, dockerfile: notification-service/Dockerfile }
          - { service: audit-service,         context: server, dockerfile: audit-service/Dockerfile }
          - { service: reporting-service,     context: server, dockerfile: reporting-service/Dockerfile }
          - { service: frontend,              context: client, dockerfile: Dockerfile }
    # Only build services that are flagged for deployment
    if: contains(needs.prepare.outputs.services, matrix.service)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./${{ matrix.service.context }}
          file: ./${{ matrix.service.context }}/${{ matrix.service.dockerfile }}
          push: true
          tags: |
            ${{ steps.ecr.outputs.registry }}/loretta-bank/${{ matrix.service.service }}:${{ github.sha }}
            ${{ steps.ecr.outputs.registry }}/loretta-bank/${{ matrix.service.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ── Deploy to EKS via Helm ──────────────────────────────────
  deploy:
    needs: [prepare, build-push]
    runs-on: ubuntu-latest
    environment: ${{ needs.prepare.outputs.environment }}
    concurrency:
      group: deploy-${{ needs.prepare.outputs.environment }}
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name ${{ needs.prepare.outputs.eks_cluster }} --region ${{ env.AWS_REGION }}

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Build Helm set flags for selected services
        id: flags
        run: |
          SERVICES='${{ needs.prepare.outputs.services }}'
          FLAGS=""

          for svc in $(echo "$SERVICES" | jq -r '.[]'); do
            FLAGS="$FLAGS --set ${svc}.image.tag=${{ github.sha }}"
          done

          echo "set_flags=$FLAGS" >> "$GITHUB_OUTPUT"

      - name: Deploy with Helm
        run: |
          helm upgrade --install loretta-bank ./helm/loretta-bank \
            --namespace loretta-bank --create-namespace \
            --values helm/loretta-bank/values-production.yaml \
            --set global.imageRegistry=${{ steps.ecr.outputs.registry }} \
            ${{ steps.flags.outputs.set_flags }} \
            --wait --timeout 10m
